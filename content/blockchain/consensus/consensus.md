+++
title = '共识'
date = 2024-03-15T16:19:44+08:00
+++

## 为什么需要共识机制

所谓共识，就是多个人达成一致的意思。

在区块链系统中，每个节点必须要做的事情就是让**自己的账本跟其他节点的账本达成一致**。如果是在传统的中心化场景中，这几乎不是问题，因为有一个中心服务器存在，也就是所谓的主库，其他的从库向主库看齐就行了。

## 什么是共识机制

共识机制（Consensus Mechanism）是通过特殊节点的投票，在**很短的时间内完成对交易的验证和确认**；对一笔交易，如果利益不相干的若干个节点能够达成共识，我们就可以认为全网对此也能够达成共识。

虽然共识 (Consensus) 和一致性 (Consistency) 在很多应用场景中被认为是近似等价的, 但二者涵义存在着细微的差别: 共识研究**侧重于分布式节点达成一致的过程及其算法**, 而一致性研究则**侧重于节点共识过程最终达成的稳定状态**; 此外, 传统分布式一致性研究大多不考虑拜占庭容错问题, 即假设不存在恶意篡改和伪造数据的拜占庭节点。毕竟，在完全公开透明的区块链网络中，无法保证所有节点都不会作恶。

## 共识机制可以解决哪些问题

共识机制可以解决**分布式系统中的信任问题**，确保各节点之间的数据一致性和安全性。在传统的分布式系统中，由于节点之间没有信任机制，容易受到恶意节点的攻击和篡改，导致系统崩溃或者数据被篡改。另外，在区块链加密技术出现之前，加密数字货币和其他资产一样，具有无限可复制性，如果没有一个中心化的媒介机构，人们没有办法确认一笔数字现金是否已经被花掉。

简单来讲，共识机制可以有效解决两个问题： **双花问题**（一笔钱被花了两次）和**拜占庭将军问题**（恶意节点篡改数据）。

## 双花问题

共识机制可以一定程度上解决双花问题（double spend attack）：即一笔钱被花了两次或者两次以上，也叫「双重支付」。

众所周知，区块链节点始终都将最长的链条视为正确的链条，并持续工作和延长它。如果有两个节点同时广播不同版本的新区块，那么将在率先收到的区块基础上进行工作，但也会保留另外一个链条，以防后者变成最长的链条。等到下一个工作量证明被发现，其中的一条链条被证实为是较长的一条，那么在另一条分支链条上工作的节点将转换阵营。

**双花是如何实现的呢？分为两种情况：**

+ **在确认前的双花。**零确认的交易本来就可能最后没有写入区块链。除非小额，最好至少等确认即可规避此类双花。
+ **在确认后的双花。**这就要控制超 50% 算力才能实施。即类似于一个小分叉，将给一个商店的交易放入孤立区块中。这种确认后双花，很难实施，只是理论上可行。

**最常见的双花攻击有三种：51% 攻击，竞争攻击（Race Attack）, 芬尼攻击（Finney Attack）。**

51% 攻击：51% 攻击是指一个人或者团体获得了区块链 51% 的哈希运算能力的控制权，这意味着他们有能力控制项目的一些方面。在工作量证明区块链（如比特币）上，这将通过获得网络采矿能力的控制权来实现。另一方面，对于权益证明区块链（如 Cardano），这将通过控制 51% 的抵押代币来实现。

竞赛攻击：一个用户同时向两个商家 ( 或者商家和用户本身 ) 发送两笔交易。因此,攻击者会收到两组货物或者收到货物和回收了原始交易成本。

芬尼攻击：一个矿工挖到一个或者一系列的块，这些**块里包含他把钱转账给自己其它地址的交易**。被挖到的块**没有被公布**，而是在矿工向商家转账时被保留。然后，商人在矿工公布他们已经挖出的区块之前释放了矿工所支付的货物。随后矿工公布已经挖出的区块，这就会抹掉转账给商家的交易，让商家自掏腰包。

## 拜占庭将军问题（Byzantine failures）

拜占庭将军问题是 Leslie Lamport 在 10 世纪 80 年代提出的一个假想问题。拜占庭是东罗马帝国的首都，由于当时拜占庭罗马帝国国土辽阔，每支军队的驻地分隔很远，将军们只能靠信使传递消息。发生战争时将军们必须制定统一的行动计划。

然而，这些将军中有叛徒，叛徒希望通过影响统一行动计划的制定与传播，破坏忠诚的将军们一致的行动计划。因此，将军们必须有一个预定的方法协议，使所有忠诚的将军够达成一致。而且少数几个叛徒不能使忠诚的将军做出错误的计划。也就是说，拜占庭将军问题的实质就是要寻找一个方法，使得将军们在一个有叛徒的**非信任环境中建立对战斗计划的共识**。

在分布式系统中，特别是在区块链网络环境中，也和拜占庭将军的环境类似，有运行正常的服务器（类似忠诚的拜占庭将军），还有故障的服务器，有破坏者的服务器（类似叛变的拜占庭将军）。共识算法的核心是在正常的节点间形成对网络状态的共识。**如果只有 3 个节点的话，拜占庭将军问题是无解的，当节点中有 x 个问题节点，而总结点数小于 3x+1 时，拜占庭将军问题无解**。

比特币的出现轻而易举地解决了这一问题，它为信息发送加入了**成本**，降低了信息传递的速率，而且加入了一个随机元素使得在一定时间内只有一个将军可以广播信息。第一个广播信息的将军就是**第一个发现有效哈希值**的计算机，只要其他将军接收到并验证通过了这个有效哈希值和附着在上面的信息，他们就只能使用新的信息更新他们的总账复制，然后重新计算哈希值。下一个计算出有效哈希值的将军就可以将自己再次更新的信息附着在有效哈希值上广播给大家。然后哈希计算竞赛从一个新的开始点重新开始。由于网络信息的持续同步，所有网络上的计算机都使用着同一版本的总账。



## 共识算法分类

根据**容错类型**的不同，共识算法可以分为两大类：**CFT 类共识算法** ( 非拜占庭容错，即不考虑恶意节点 ) 和 **BFT 类共识算法**（拜占庭容错，也就是说考虑恶意节点）。

是否容忍拜占庭标志着该算法是否能够应用到低信任的网络当中。通常来说，公有链环境中必须使用拜占庭容错算法，而联盟链中可以根据联盟参与方之间的信任程度进行选择，信任程度高默认大家都是善意节点就可以使用 CFT 类算法（非拜占庭容错）。

另外可以根据**一致性**被分为两大类：**概率一致性算法和绝对一致性算法**。概率一致性算法指在不同分布式节点之间，有较大概率保证节点间数据达到一致，但仍存在一定概率使得某些节点间数据不一致。例如工作量证明算法（Proof of Work, PoW）、股份证明算法（Proof of Stake, PoS）和委托股权证明算法（Delegated Proof of Stake, DPoS）都属于概率一致性算法。

绝对一致性算法则指在任意时间点，不同分布式节点之间的数据都会保持绝对一致，不存在不同节点间数据不一致的情况。例如 PAXOS 算法及其衍生出的 RAFT 算法。